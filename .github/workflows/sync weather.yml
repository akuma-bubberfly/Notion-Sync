name: Sync Weather

on:
  schedule:
    - cron: '0 0 * * *'     # midnight
    - cron: '0 12 * * *'    # noon (50% chance)
  workflow_dispatch:        # allows manual run

jobs:
  update-weather:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install notion-client

      - name: Conditional midday roll
        if: ${{ github.event.schedule == '0 12 * * *' }}
        run: |
          echo "Midday trigger detected. Rolling probability..."
          ROLL=$(awk -v seed=$RANDOM 'BEGIN{srand(seed); print rand()}')
          echo "Roll: $ROLL"
          if (( $(echo "$ROLL > 0.5" | bc -l) )); then
            echo "Midday run proceeding (roll > 0.5)."
          else
            echo "Midday run cancelled (roll <= 0.5)."
            exit 0
          fi

      - name: Run sync_weather.py
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN_STARDEW }}
          PLAYERSTATS_DB_ID: ${{ secrets.NOTION_DATABASE_ID_STARDEW }}
        run: |
          python scripts/sync_weather.py